<!DOCTYPE html><html><head><meta http-equiv="Content-Type" content="text/html; charset=utf-8"><title>Open WebUI and Mistral Agents: Social Worker Agent example</title><style>
      * {
        font-family: Georgia, Cambria, "Times New Roman", Times, serif;
      }
      html, body {
        margin: 0;
        padding: 0;
      }
      h1 {
        font-size: 50px;
        margin-bottom: 17px;
        color: #333;
      }
      h2 {
        font-size: 24px;
        line-height: 1.6;
        margin: 30px 0 0 0;
        margin-bottom: 18px;
        margin-top: 33px;
        color: #333;
      }
      h3 {
        font-size: 30px;
        margin: 10px 0 20px 0;
        color: #333;
      }
      header {
        width: 640px;
        margin: auto;
      }
      section {
        width: 640px;
        margin: auto;
      }
      section p {
        margin-bottom: 27px;
        font-size: 20px;
        line-height: 1.6;
        color: #333;
      }
      section img {
        max-width: 640px;
      }
      footer {
        padding: 0 20px;
        margin: 50px 0;
        text-align: center;
        font-size: 12px;
      }
      .aspectRatioPlaceholder {
        max-width: auto !important;
        max-height: auto !important;
      }
      .aspectRatioPlaceholder-fill {
        padding-bottom: 0 !important;
      }
      header,
      section[data-field=subtitle],
      section[data-field=description] {
        display: none;
      }
      </style></head><body><article class="h-entry">
<header>
<h1 class="p-name">Open WebUI and Mistral Agents: Social Worker Agent example</h1>
</header>
<section data-field="subtitle" class="p-summary">
Did you know that you can integrate an LLM model into a conversation using the ‘@’ character? For example, you can ask questions to a…
</section>
<section data-field="body" class="e-content">
<section name="9f9f" class="section section--body section--first"><div class="section-divider"><hr class="section-divider"></div><div class="section-content"><div class="section-inner sectionLayout--insetColumn"><h3 name="e272" id="e272" class="graf graf--h3 graf--leading graf--title">Open WebUI and Mistral Agents: Social Worker Agent example</h3><p name="5efd" id="5efd" class="graf graf--p graf-after--h3">Did you know that you can integrate an LLM model into a conversation using the ‘@’ character? For example, you can ask questions to a locally installed LLM and then continue with remote agents. I utilized this feature to create a pipeline for the Mistral API, enabling Mistral Agents to be used directly in conversations.</p><p name="98c4" id="98c4" class="graf graf--p graf-after--p">In this example, I demonstrate how to use the Social Worker agent via the Open WebUI interface (in Finnish). I have trained the agent with the latest social work legislation in Finnish (Sosiaalihuoltolain soveltamisopas 2024, <a href="https://stm.fi/julkaisu?pubid=URN:ISBN:978-952-00-7155-4" data-href="https://stm.fi/julkaisu?pubid=URN:ISBN:978-952-00-7155-4" class="markup--anchor markup--p-anchor" rel="noopener" target="_blank">link</a>) and more. This is similar to the Sosiaalineuvoja (Social Instructor) for ChatGPT that I created last year (<a href="https://medium.com/@jari.p.hiltunen/sosiaalineuvoja-monikielinen-ja-monipuolinen-avustaja-f9b39507b673" data-href="https://medium.com/@jari.p.hiltunen/sosiaalineuvoja-monikielinen-ja-monipuolinen-avustaja-f9b39507b673" class="markup--anchor markup--p-anchor" target="_blank">link</a>).</p><p name="cb19" id="cb19" class="graf graf--p graf-after--p graf--trailing">Next, I will explain how to enable these features in Open WebUI and Mistral. You can start with Mistral’s free plan, as it works well for testing.</p></div></div></section><section name="856c" class="section section--body"><div class="section-divider"><hr class="section-divider"></div><div class="section-content"><div class="section-inner sectionLayout--insetColumn"><h3 name="1540" id="1540" class="graf graf--h3 graf--leading">Create and fine tune your agent</h3><p name="2c6f" id="2c6f" class="graf graf--p graf-after--h3">Go to Mistral Agents (<a href="https://console.mistral.ai/build/agents" data-href="https://console.mistral.ai/build/agents" class="markup--anchor markup--p-anchor" rel="noopener" target="_blank">link</a>) and create your agent. Check “API” and copy the agent ID (begins with ag:). If you do not have free or paid substriction, you can activate it here (<a href="https://console.mistral.ai/billing" data-href="https://console.mistral.ai/billing" class="markup--anchor markup--p-anchor" rel="noopener" target="_blank">link</a>). You need to copy the agent ID to the Python code below, which will be a new Function in Open WebUI.</p><figure name="17f2" id="17f2" class="graf graf--figure graf-after--p"><img class="graf-image" data-image-id="1*Za8q_nIFYxN5E4tEfAG2UQ.png" data-width="1279" data-height="838" data-is-featured="true" src="https://cdn-images-1.medium.com/max/800/1*Za8q_nIFYxN5E4tEfAG2UQ.png"><figcaption class="imageCaption">Agent creation at Mistral website</figcaption></figure><p name="3bd1" id="3bd1" class="graf graf--p graf-after--figure graf--trailing">Remember to train the agent with typical questions and responses. In this case dialogue and empathy are key for succesfull converstation.</p></div></div></section><section name="9f24" class="section section--body"><div class="section-divider"><hr class="section-divider"></div><div class="section-content"><div class="section-inner sectionLayout--insetColumn"><h3 name="a87b" id="a87b" class="graf graf--h3 graf--leading">Adjust the Function code for your agent</h3><p name="caa4" id="caa4" class="graf graf--p graf-after--h3">Since we are pointing to the agent with the ‘@’ character, each agent needs its own function. In the code code below, update the following lines:</p><pre data-code-block-mode="1" spellcheck="false" data-code-block-lang="ini" name="0ae3" id="0ae3" class="graf graf--pre graf-after--p graf--preV2"><span class="pre--content"><span class="hljs-attr">self.agent_1_id</span> = <span class="hljs-string">&quot;ag:xxxxx&quot;</span>  <span class="hljs-comment"># This ID is from the Mistral website.</span><br /><span class="hljs-attr">self.agent_1_name</span> = <span class="hljs-string">&quot;Name for your agent&quot;</span>  <span class="hljs-comment"># The name displayed in Open WebUI.</span></span></pre><p name="fb09" id="fb09" class="graf graf--p graf-after--pre"><strong class="markup--strong markup--p-strong">Note:</strong> <code class="markup--code markup--p-code">self.agent_1_name</code> is the name you will see in the Open WebUI. In the example below, <code class="markup--code markup--p-code">self.name</code> starts with <code class="markup--code markup--p-code">&quot;agent/&quot;</code> and is followed by <code class="markup--code markup--p-code">&quot;Social Work&quot;</code>, which comes from the <code class="markup--code markup--p-code">self.agent_1_name</code> variable.&quot;</p><figure name="1b01" id="1b01" class="graf graf--figure graf-after--p"><img class="graf-image" data-image-id="1*8mDsKAslCPCGSjxAjJVjLA.png" data-width="1533" data-height="909" src="https://cdn-images-1.medium.com/max/800/1*8mDsKAslCPCGSjxAjJVjLA.png"><figcaption class="imageCaption">Chat with Social Work agent</figcaption></figure><p name="20c9" id="20c9" class="graf graf--p graf-after--figure">After modifying the code, go to Open WebUI Admin → Functions → New Function. Copy — Paste the modified code, assign a name to the function, and save it.</p><figure name="4f0f" id="4f0f" class="graf graf--figure graf-after--p"><img class="graf-image" data-image-id="1*Uokt1e1fnI-znaJA2VGX6g.png" data-width="897" data-height="902" src="https://cdn-images-1.medium.com/max/800/1*Uokt1e1fnI-znaJA2VGX6g.png"><figcaption class="imageCaption">Copy — paste code to the Function</figcaption></figure><p name="959d" id="959d" class="graf graf--p graf-after--figure">Then press gear at the right of the Function, and paste your Mistral API-key here. If you do not have API-key, you can generate it here (<a href="https://console.mistral.ai/api-keys/" data-href="https://console.mistral.ai/api-keys/" class="markup--anchor markup--p-anchor" rel="noopener" target="_blank">link</a>). If you do not have free or paid substriction, you can activate it here (<a href="https://console.mistral.ai/billing" data-href="https://console.mistral.ai/billing" class="markup--anchor markup--p-anchor" rel="noopener" target="_blank">link</a>).</p><figure name="fc75" id="fc75" class="graf graf--figure graf-after--p"><img class="graf-image" data-image-id="1*OTTPrJ4iruoRDASXrzbEHQ.png" data-width="1222" data-height="346" src="https://cdn-images-1.medium.com/max/800/1*OTTPrJ4iruoRDASXrzbEHQ.png"></figure><p name="83e8" id="83e8" class="graf graf--p graf-after--figure">Now you should have new model listed in Open WebUI Models-selection. Test it and if you see all works as should, then go back to the code and change debugging to false:</p><pre data-code-block-mode="1" spellcheck="false" data-code-block-lang="python" name="317f" id="317f" class="graf graf--pre graf-after--p graf--preV2"><span class="pre--content">    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__init__</span>(<span class="hljs-params">self</span>):<br />        self.debug_stream = <span class="hljs-literal">False</span><br />        self.debug_tokens = <span class="hljs-literal">False</span><br />        self.debug_errors = <span class="hljs-literal">False</span></span></pre><p name="af07" id="af07" class="graf graf--p graf-after--pre">The code is available from OpenWeb UI website (<a href="https://openwebui.com/f/hiltsu/mistral_agent_pipe" data-href="https://openwebui.com/f/hiltsu/mistral_agent_pipe" class="markup--anchor markup--p-anchor" rel="noopener" target="_blank">link</a>) and from my GitHub (<a href="https://github.com/divergentti/openwebui" data-href="https://github.com/divergentti/openwebui" class="markup--anchor markup--p-anchor" rel="noopener" target="_blank">link</a>). Below is the Function code you need to adjust for your agent:</p><pre data-code-block-mode="2" spellcheck="false" data-code-block-lang="python" name="9e03" id="9e03" class="graf graf--pre graf-after--p graf--trailing graf--preV2"><span class="pre--content"><span class="hljs-comment"># title: Mistral Agents Pipe</span><br /><span class="hljs-comment"># authors: Jari Hiltunen</span><br /><span class="hljs-comment"># author_url: https://github.com/divergentti</span><br /><span class="hljs-comment"># version: 0.0.1 (23.01.2025)</span><br /><span class="hljs-comment"># required_open_webui_version: 0.3.17</span><br /><span class="hljs-comment"># license: MIT</span><br /><span class="hljs-comment">#</span><br /><span class="hljs-comment"># Before using, create your free API-keys at https://console.mistral.ai/api-keys/</span><br /><span class="hljs-comment"># Create, educate and fine tune your agent here https://console.mistral.ai/build/agents</span><br /><span class="hljs-comment"># Pick the agent ID from the page, begins with ag:</span><br /><span class="hljs-comment"># After installing this Function, add your API-key to the Valves of the Function (gear rightmost)</span><br /><span class="hljs-comment"># Use @ to pick up the agent to your conversation in Open WebUI</span><br /><span class="hljs-keyword">import</span> os<br /><span class="hljs-keyword">import</span> requests<br /><span class="hljs-keyword">import</span> json<br /><span class="hljs-keyword">import</span> time<br /><span class="hljs-keyword">from</span> typing <span class="hljs-keyword">import</span> <span class="hljs-type">List</span>, <span class="hljs-type">Union</span>, Generator, Iterator, <span class="hljs-type">Dict</span><br /><span class="hljs-keyword">from</span> pydantic <span class="hljs-keyword">import</span> BaseModel, Field<br /><span class="hljs-keyword">from</span> open_webui.utils.misc <span class="hljs-keyword">import</span> pop_system_message<br /><br /><br /><span class="hljs-keyword">class</span> <span class="hljs-title class_">Pipe</span>:<br />    <span class="hljs-keyword">class</span> <span class="hljs-title class_">Valves</span>(<span class="hljs-title class_ inherited__">BaseModel</span>):<br />        MISTRAL_API_KEY: <span class="hljs-built_in">str</span> = Field(default=<span class="hljs-string">&quot;&quot;</span>)<br /><br />    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__init__</span>(<span class="hljs-params">self</span>):<br />        self.debug_stream = <span class="hljs-literal">True</span><br />        self.debug_tokens = <span class="hljs-literal">True</span><br />        self.debug_errors = <span class="hljs-literal">True</span><br />        self.<span class="hljs-built_in">type</span> = <span class="hljs-string">&quot;manifold&quot;</span><br />        self.<span class="hljs-built_in">id</span> = <span class="hljs-string">&quot;mistral-agents&quot;</span><br />        self.name = <span class="hljs-string">&quot;agent/&quot;</span><br />        self.agents_endpoint = <span class="hljs-string">&quot;https://api.mistral.ai/v1/agents/completions&quot;</span><br />        self.agent_1_id = <span class="hljs-string">&quot;ag:xxxx:social-work-and-empathy-agent:xxx8a8&quot;</span>  <span class="hljs-comment"># Pick this from Mistral</span><br />        self.agent_1_name = <span class="hljs-string">&quot;Social Work&quot;</span>  <span class="hljs-comment"># This is name listed in agents and callable with @-sign during chat</span><br />        self.top_p = <span class="hljs-number">0.9</span><br />        self.max_tokens = <span class="hljs-number">4096</span><br />        self.max_tokens_minute = <span class="hljs-number">500000</span>  <span class="hljs-comment"># Tokens per minute</span><br />        self.tokens_left = (<br />            <span class="hljs-number">1000000000</span>  <span class="hljs-comment"># Will be updated from stream, this is max per month</span><br />        )<br />        self.total_tokens_used = <span class="hljs-number">0</span><br />        api_key = os.getenv(<span class="hljs-string">&quot;MISTRAL_API_KEY&quot;</span>, <span class="hljs-string">&quot;&quot;</span>).strip()<br />        self.valves = self.Valves(MISTRAL_API_KEY=api_key)<br />        self.last_request_time: <span class="hljs-built_in">float</span> = (<br />            <span class="hljs-number">0.0</span>  <span class="hljs-comment"># Initialize the last request time for rate limiting</span><br />        )<br />        self.rate_limit_reset: <span class="hljs-built_in">float</span> = <span class="hljs-number">0.0</span>  <span class="hljs-comment"># Initialize rate_limit_reset to 0</span><br />        self.rate_limit_interval: <span class="hljs-built_in">float</span> = (<br />            <span class="hljs-number">30.0</span>  <span class="hljs-comment"># Set the rate limit interval in seconds (Open is 100 request per hour)</span><br />        )<br />        self.last_token_reset_time = time.time()  <span class="hljs-comment"># Initialize the last token reset time</span><br />        self.tokens_used_this_minute = <span class="hljs-number">0</span>  <span class="hljs-comment"># Initialize tokens used this minute</span><br /><br />    <span class="hljs-keyword">def</span> <span class="hljs-title function_">pipes</span>(<span class="hljs-params">self</span>) -&gt; <span class="hljs-type">List</span>[<span class="hljs-built_in">dict</span>]:<br />        <span class="hljs-keyword">if</span> self.agent_1_id:<br />            <span class="hljs-keyword">return</span> [{<span class="hljs-string">&quot;id&quot;</span>: self.agent_1_id, <span class="hljs-string">&quot;name&quot;</span>: self.agent_1_name}]<br /><br />    <span class="hljs-keyword">def</span> <span class="hljs-title function_">pipe</span>(<span class="hljs-params">self, body: <span class="hljs-built_in">dict</span></span>) -&gt; <span class="hljs-type">Union</span>[<span class="hljs-built_in">str</span>, Generator, Iterator]:<br />        system_message, messages = pop_system_message(body[<span class="hljs-string">&quot;messages&quot;</span>])<br />        processed_messages = []<br />        <span class="hljs-keyword">for</span> message <span class="hljs-keyword">in</span> messages:<br />            processed_content = []<br />            <span class="hljs-keyword">if</span> <span class="hljs-built_in">isinstance</span>(message.get(<span class="hljs-string">&quot;content&quot;</span>), <span class="hljs-built_in">list</span>):<br />                <span class="hljs-keyword">for</span> item <span class="hljs-keyword">in</span> message[<span class="hljs-string">&quot;content&quot;</span>]:<br />                    <span class="hljs-keyword">if</span> item[<span class="hljs-string">&quot;type&quot;</span>] == <span class="hljs-string">&quot;text&quot;</span>:<br />                        processed_content.append({<span class="hljs-string">&quot;type&quot;</span>: <span class="hljs-string">&quot;text&quot;</span>, <span class="hljs-string">&quot;text&quot;</span>: item[<span class="hljs-string">&quot;text&quot;</span>]})<br />            <span class="hljs-keyword">else</span>:<br />                processed_content = [<br />                    {<span class="hljs-string">&quot;type&quot;</span>: <span class="hljs-string">&quot;text&quot;</span>, <span class="hljs-string">&quot;text&quot;</span>: message.get(<span class="hljs-string">&quot;content&quot;</span>, <span class="hljs-string">&quot;&quot;</span>)}<br />                ]<br />            processed_messages.append(<br />                {<span class="hljs-string">&quot;role&quot;</span>: message[<span class="hljs-string">&quot;role&quot;</span>], <span class="hljs-string">&quot;content&quot;</span>: processed_content}<br />            )<br />        <span class="hljs-comment"># payload is defined as it is at mistral.ai website</span><br />        payload = {<br />            <span class="hljs-string">&quot;agent_id&quot;</span>: self.agent_1_id,<br />            <span class="hljs-string">&quot;top_p&quot;</span>: body.get(<span class="hljs-string">&quot;top_p&quot;</span>, self.top_p),<br />            <span class="hljs-string">&quot;max_tokens&quot;</span>: body.get(<span class="hljs-string">&quot;max_tokens&quot;</span>, self.max_tokens),<br />            <span class="hljs-string">&quot;stream&quot;</span>: body.get(<span class="hljs-string">&quot;stream&quot;</span>, <span class="hljs-literal">False</span>),<br />            <span class="hljs-string">&quot;messages&quot;</span>: processed_messages,<br />        }<br />        headers = {<br />            <span class="hljs-string">&quot;Authorization&quot;</span>: <span class="hljs-string">f&quot;Bearer <span class="hljs-subst">{self.valves.MISTRAL_API_KEY}</span>&quot;</span>,<br />            <span class="hljs-string">&quot;mistral-version&quot;</span>: <span class="hljs-string">&quot;2025-01-01&quot;</span>,<br />            <span class="hljs-string">&quot;Content-Type&quot;</span>: <span class="hljs-string">&quot;application/json&quot;</span>,<br />            <span class="hljs-string">&quot;user-agent&quot;</span>: <span class="hljs-string">&quot;MistralAgent/1.0&quot;</span>,<br />            <span class="hljs-string">&quot;accept&quot;</span>: <span class="hljs-string">&quot;application/json&quot;</span>,<br />        }<br />        <span class="hljs-keyword">if</span> self.debug_stream:<br />            <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;Headers being sent   :&quot;</span>, headers)<br />        <span class="hljs-comment"># Rate limiting</span><br />        current_time = time.time()<br />        elapsed_time: <span class="hljs-built_in">float</span> = current_time - self.last_request_time<br />        <span class="hljs-keyword">if</span> elapsed_time &lt; self.rate_limit_interval:<br />            sleep_time: <span class="hljs-built_in">float</span> = <span class="hljs-built_in">max</span>(<span class="hljs-number">0.0</span>, <span class="hljs-built_in">float</span>(self.rate_limit_reset) - time.time())<br />            <span class="hljs-keyword">if</span> self.debug_stream:<br />                <span class="hljs-built_in">print</span>(<span class="hljs-string">f&quot;Rate limit exceeded. Sleeping for <span class="hljs-subst">{sleep_time:<span class="hljs-number">.2</span>f}</span> seconds.&quot;</span>)<br />            time.sleep(sleep_time)<br />        self.last_request_time = time.time()<br />        <span class="hljs-keyword">try</span>:<br />            <span class="hljs-keyword">if</span> body.get(<span class="hljs-string">&quot;stream&quot;</span>, <span class="hljs-literal">False</span>):<br />                <span class="hljs-keyword">return</span> self.stream_response(self.agents_endpoint, headers, payload)<br />            <span class="hljs-keyword">else</span>:<br />                <span class="hljs-keyword">return</span> self.non_stream_response(self.agents_endpoint, headers, payload)<br />        <span class="hljs-keyword">except</span> requests.exceptions.RequestException <span class="hljs-keyword">as</span> e:<br />            <span class="hljs-keyword">if</span> self.debug_stream:<br />                <span class="hljs-built_in">print</span>(<span class="hljs-string">f&quot;Request failed: <span class="hljs-subst">{e}</span>&quot;</span>)<br />            <span class="hljs-keyword">return</span> <span class="hljs-string">f&quot;Error: Request failed: <span class="hljs-subst">{e}</span>&quot;</span><br />        <span class="hljs-keyword">except</span> Exception <span class="hljs-keyword">as</span> e:<br />            <span class="hljs-keyword">if</span> self.debug_stream:<br />                <span class="hljs-built_in">print</span>(<span class="hljs-string">f&quot;Error in pipe method: <span class="hljs-subst">{e}</span>&quot;</span>)<br />            <span class="hljs-keyword">return</span> <span class="hljs-string">f&quot;Error: <span class="hljs-subst">{e}</span>&quot;</span><br /><br />    <span class="hljs-keyword">def</span> <span class="hljs-title function_">stream_response</span>(<span class="hljs-params">self, url, headers, payload</span>):<br />        headers[<span class="hljs-string">&quot;Authorization&quot;</span>] = <span class="hljs-string">f&quot;Bearer <span class="hljs-subst">{self.valves.MISTRAL_API_KEY}</span>&quot;</span><br />        <span class="hljs-keyword">try</span>:<br />            <span class="hljs-keyword">with</span> requests.post(<br />                url, headers=headers, json=payload, stream=<span class="hljs-literal">True</span>, timeout=(<span class="hljs-number">3.05</span>, <span class="hljs-number">60</span>)<br />            ) <span class="hljs-keyword">as</span> response:<br />                <span class="hljs-keyword">if</span> response.status_code != <span class="hljs-number">200</span>:<br />                    <span class="hljs-keyword">raise</span> Exception(<br />                        <span class="hljs-string">f&quot;HTTP Error <span class="hljs-subst">{response.status_code}</span>: <span class="hljs-subst">{response.text}</span>&quot;</span><br />                    )<br />                <span class="hljs-keyword">for</span> line <span class="hljs-keyword">in</span> response.iter_lines():Code you need to modify<br />                    <span class="hljs-keyword">if</span> self.debug_stream:<br />                        <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;Response line: &quot;</span>, line)<br />                    <span class="hljs-keyword">if</span> line:<br />                        line = line.decode(<span class="hljs-string">&quot;utf-8&quot;</span>)<br />                        <span class="hljs-keyword">if</span> line == <span class="hljs-string">&quot;data: [DONE]&quot;</span>:<br />                            <span class="hljs-keyword">if</span> self.debug_stream:<br />                                <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;Streaming completed successfully.&quot;</span>)<br />                            <span class="hljs-keyword">break</span><br />                        <span class="hljs-keyword">if</span> line.startswith(<span class="hljs-string">&quot;data: &quot;</span>):<br />                            <span class="hljs-keyword">try</span>:<br />                                data = json.loads(line[<span class="hljs-number">6</span>:])<br />                                <span class="hljs-keyword">if</span> data.get(<span class="hljs-string">&quot;choices&quot;</span>):<br />                                    <span class="hljs-keyword">for</span> choice <span class="hljs-keyword">in</span> data[<span class="hljs-string">&quot;choices&quot;</span>]:<br />                                        <span class="hljs-keyword">if</span> (<br />                                            <span class="hljs-string">&quot;delta&quot;</span> <span class="hljs-keyword">in</span> choice<br />                                            <span class="hljs-keyword">and</span> <span class="hljs-string">&quot;content&quot;</span> <span class="hljs-keyword">in</span> choice[<span class="hljs-string">&quot;delta&quot;</span>]<br />                                        ):<br />                                            <span class="hljs-keyword">yield</span> choice[<span class="hljs-string">&quot;delta&quot;</span>][<span class="hljs-string">&quot;content&quot;</span>]<br />                                        <span class="hljs-keyword">elif</span> (<br />                                            <span class="hljs-string">&quot;finish_reason&quot;</span> <span class="hljs-keyword">in</span> choice<br />                                            <span class="hljs-keyword">and</span> choice[<span class="hljs-string">&quot;finish_reason&quot;</span>] == <span class="hljs-string">&quot;stop&quot;</span><br />                                        ):<br />                                            <span class="hljs-keyword">break</span><br />                                    <span class="hljs-comment"># Extract token usage information</span><br />                                    usage = data.get(<span class="hljs-string">&quot;usage&quot;</span>, {})<br />                                    prompt_tokens = usage.get(<span class="hljs-string">&quot;prompt_tokens&quot;</span>, <span class="hljs-number">0</span>)<br />                                    completion_tokens = usage.get(<br />                                        <span class="hljs-string">&quot;completion_tokens&quot;</span>, <span class="hljs-number">0</span><br />                                    )<br />                                    total_tokens = usage.get(<span class="hljs-string">&quot;total_tokens&quot;</span>, <span class="hljs-number">0</span>)<br />                                    <span class="hljs-comment"># Update total tokens used</span><br />                                    self.total_tokens_used += total_tokens<br />                                    self.tokens_left -= total_tokens<br />                                    <span class="hljs-comment"># Update tokens used this minute</span><br />                                    self.tokens_used_this_minute += total_tokens<br />                                    <span class="hljs-comment"># Check if a minute has passed</span><br />                                    <span class="hljs-keyword">if</span> time.time() - self.last_token_reset_time &gt;= <span class="hljs-number">60</span>:<br />                                        self.tokens_used_this_minute = <span class="hljs-number">0</span><br />                                        self.last_token_reset_time = time.time()<br />                                    <span class="hljs-keyword">if</span> self.debug_tokens <span class="hljs-keyword">and</span> total_tokens &gt; <span class="hljs-number">0</span>:<br />                                        <span class="hljs-built_in">print</span>(<span class="hljs-string">f&quot;Prompt Tokens: <span class="hljs-subst">{prompt_tokens}</span>&quot;</span>)<br />                                        <span class="hljs-built_in">print</span>(<span class="hljs-string">f&quot;Completion Tokens: <span class="hljs-subst">{completion_tokens}</span>&quot;</span>)<br />                                        <span class="hljs-built_in">print</span>(<span class="hljs-string">f&quot;Total Tokens: <span class="hljs-subst">{total_tokens}</span>&quot;</span>)<br />                                        <span class="hljs-built_in">print</span>(<br />                                            <span class="hljs-string">f&quot;Total Tokens Used: <span class="hljs-subst">{self.total_tokens_used}</span>&quot;</span><br />                                        )<br />                                        <span class="hljs-built_in">print</span>(<span class="hljs-string">f&quot;Tokens Left: <span class="hljs-subst">{self.tokens_left}</span>&quot;</span>)<br />                                        <span class="hljs-built_in">print</span>(<br />                                            <span class="hljs-string">f&quot;Tokens Used This Minute: <span class="hljs-subst">{self.tokens_used_this_minute}</span>&quot;</span><br />                                        )<br />                                    time.sleep(<br />                                        <span class="hljs-number">0.01</span><br />                                    )  <span class="hljs-comment"># Delay to avoid overwhelming the client</span><br />                            <span class="hljs-keyword">except</span> json.JSONDecodeError:<br />                                <span class="hljs-keyword">if</span> self.debug_stream:<br />                                    <span class="hljs-built_in">print</span>(<span class="hljs-string">f&quot;Failed to parse JSON: <span class="hljs-subst">{line}</span>&quot;</span>)<br />                            <span class="hljs-keyword">except</span> KeyError <span class="hljs-keyword">as</span> e:<br />                                <span class="hljs-keyword">if</span> self.debug_stream:<br />                                    <span class="hljs-built_in">print</span>(<span class="hljs-string">f&quot;Unexpected data structure: <span class="hljs-subst">{e}</span>&quot;</span>)<br />                                    <span class="hljs-built_in">print</span>(<span class="hljs-string">f&quot;Full data: <span class="hljs-subst">{data}</span>&quot;</span>)<br />        <span class="hljs-keyword">except</span> requests.exceptions.RequestException <span class="hljs-keyword">as</span> e:<br />            <span class="hljs-keyword">if</span> self.debug_stream:<br />                <span class="hljs-built_in">print</span>(<span class="hljs-string">f&quot;Request failed: <span class="hljs-subst">{e}</span>&quot;</span>)<br />            <span class="hljs-keyword">yield</span> <span class="hljs-string">f&quot;Error: Request failed: <span class="hljs-subst">{e}</span>&quot;</span><br />        <span class="hljs-keyword">except</span> Exception <span class="hljs-keyword">as</span> e:<br />            <span class="hljs-keyword">if</span> self.debug_stream:<br />                <span class="hljs-built_in">print</span>(<span class="hljs-string">f&quot;General error in stream_response method: <span class="hljs-subst">{e}</span>&quot;</span>)<br />            <span class="hljs-keyword">yield</span> <span class="hljs-string">f&quot;Error: <span class="hljs-subst">{e}</span>&quot;</span><br /><br />    <span class="hljs-keyword">def</span> <span class="hljs-title function_">non_stream_response</span>(<span class="hljs-params">self, url, headers, payload</span>):<br />        headers[<span class="hljs-string">&quot;Authorization&quot;</span>] = <span class="hljs-string">f&quot;Bearer <span class="hljs-subst">{self.valves.MISTRAL_API_KEY}</span>&quot;</span><br />        <span class="hljs-keyword">try</span>:<br />            response = requests.post(<br />                url, headers=headers, json=payload, timeout=(<span class="hljs-number">3.05</span>, <span class="hljs-number">60</span>)<br />            )<br />            <span class="hljs-keyword">if</span> response.status_code != <span class="hljs-number">200</span>:<br />                <span class="hljs-keyword">raise</span> Exception(<span class="hljs-string">f&quot;HTTP Error <span class="hljs-subst">{response.status_code}</span>: <span class="hljs-subst">{response.text}</span>&quot;</span>)<br />            res = response.json()<br />            <span class="hljs-keyword">return</span> (<br />                res[<span class="hljs-string">&quot;choices&quot;</span>][<span class="hljs-number">0</span>][<span class="hljs-string">&quot;message&quot;</span>][<span class="hljs-string">&quot;content&quot;</span>]<br />                <span class="hljs-keyword">if</span> <span class="hljs-string">&quot;choices&quot;</span> <span class="hljs-keyword">in</span> res <span class="hljs-keyword">and</span> res[<span class="hljs-string">&quot;choices&quot;</span>]<br />                <span class="hljs-keyword">else</span> <span class="hljs-string">&quot;&quot;</span><br />            )<br />        <span class="hljs-keyword">except</span> requests.exceptions.RequestException <span class="hljs-keyword">as</span> e:<br />            <span class="hljs-keyword">if</span> self.debug_stream:<br />                <span class="hljs-built_in">print</span>(<span class="hljs-string">f&quot;Failed non-stream request: <span class="hljs-subst">{e}</span>&quot;</span>)<br />            <span class="hljs-keyword">return</span> <span class="hljs-string">f&quot;Error: <span class="hljs-subst">{e}</span>&quot;</span></span></pre></div></div></section><section name="8732" class="section section--body"><div class="section-divider"><hr class="section-divider"></div><div class="section-content"><div class="section-inner sectionLayout--insetColumn"><h3 name="7ad2" id="7ad2" class="graf graf--h3 graf--leading">Example conversation in Finnish</h3><p name="fc2d" id="fc2d" class="graf graf--p graf-after--h3">For first question I used the locally installed Ollama LLM “@phi4:latest” and asked “Kerro jotain alkoholismista.” (Tell me something about alcoholism):</p><blockquote name="f2e8" id="f2e8" class="graf graf--blockquote graf-after--p">phi4:latest</blockquote><blockquote name="8bba" id="8bba" class="graf graf--blockquote graf-after--blockquote">Alkoholismin käsitteellistäminen vaatii sekä tieteellisen että filosofisen näkökulman, sillä se on monimutkaista ja yksilöllisesti vaihtelevaa.</blockquote><blockquote name="f609" id="f609" class="graf graf--blockquote graf-after--blockquote"><strong class="markup--strong markup--blockquote-strong">Professionaalinen näkökulma:</strong></blockquote><blockquote name="3aea" id="3aea" class="graf graf--blockquote graf-after--blockquote">Alkoholismi tunnetaan myös alkoholin riippuvuudeksi tai alkoholiriippuvuudeksi. Se on sairaus, joka vaikuttaa aivojen kemiallisiin ja rakenteellisiin piirteisiin, mikä johtaa hallitsemattomaan juomiseen huolimatta sen negatiivisista seurauksista. Alkoholismi voidaan diagnosoida, kun yksilöllä on useita seuraavista oireista: tarve juoda alkoholia enemmän ja useammin kuin suunniteltu; hallinnan menetys; pysyvä halu tai yritys vähentää juomista; käytön jatkaminen huolimatta sen sosiaalisista, terveydellisistä tai oikeudellisista seurauksista; käyttöoireiden poisto pitkällä juomiskerralla ja erittäin voimakas halu saada alkoholia (toleranssin väheneminen).</blockquote><blockquote name="b26a" id="b26a" class="graf graf--blockquote graf-after--blockquote">Tieteellisen tutkimuksen mukaan monet tekijät, kuten geneettiset predispositionit, ympäristötekijät, psykologiset oireyhtymät ja sosiaaliset normit, voivat vaikuttaa alkoholismiin. Hoito voi sisältää monialaisen lähestymistavan, johon kuuluu terapia, tukiryhmät kuten Anonyymit Alkoholistit sekä joskus lääkehoidot.</blockquote><blockquote name="ac65" id="ac65" class="graf graf--blockquote graf-after--blockquote"><strong class="markup--strong markup--blockquote-strong">Filosofinen näkökulma:</strong></blockquote><blockquote name="0571" id="0571" class="graf graf--blockquote graf-after--blockquote">Alkoholismista voi käydä syvällisiä keskusteluja itsen vapauden ja kontrollin filosofisista kysymyksistä. Onko alkoholismin oireet todella hallitsemattomia, vai ovatko ne osa laajempaa kykyämme valita itsellemme? Tämän kysymyksen tarkastelu saattaa johtaa yhteiskunnallisen ja moraalisen vastuun analyysiin — voisiko parempi ymmärrys alkoholismista auttaa muokkaamaan empaattisempia yhteiskuntapolitiikkoja?</blockquote><blockquote name="8ce4" id="8ce4" class="graf graf--blockquote graf-after--blockquote">Myös eettiset kysymykset nousevat esiin, kuten: Millainen rooli valtion ja yksilön vastuu on alkoholin kulutuksen ohjauksessa? Mikä tekee hoidon tai hoitokelpoisuuden oikealla tai väärällä tavalla “vapaaksi”?</blockquote><blockquote name="91ca" id="91ca" class="graf graf--blockquote graf-after--blockquote"><strong class="markup--strong markup--blockquote-strong">Divergenttia ajattelua:</strong></blockquote><blockquote name="7ee8" id="7ee8" class="graf graf--blockquote graf-after--blockquote">Mietitään vaihtoehtoista skenaariota, jossa yhteiskunta ottaisi kokonaan uudenlaisen lähestymistavan alkoholismiin. Kuvitellaan, että alkoholirikas yhteiskunta olisi tullut sopusointuun sen terveydellisten ja sosiaalisten vaikutusten kanssa ilman tuomitsevaa suhtautumista, eikä stigma estäisi ihmisiä hakeutumasta apua. Miten se muuttaisi yksilöiden kokemuksia riippuvuuden hoitamisessa? Toisaalta, mikäli alkoholin käyttö olisi täysin vapautettu ilman minkäänlaista sääntelyä, mitä voimakkaita seurauksia voisimme nähdä?</blockquote><blockquote name="ce08" id="ce08" class="graf graf--blockquote graf-after--blockquote">Nämä eri näkökulmat ja vaihtoehtoiset ajattelutavat auttavat syventämään ymmärrystämme alkoholismista ja sen moninaisista vaikutuksista sekä yksilöiden että yhteiskunnan tasolla.</blockquote><p name="7f02" id="7f02" class="graf graf--p graf-after--blockquote">Then I continued conversation with just created Mistral Agent “@Social Work” and asked “Mitä mieltä sinä olet edellisestä?” (What do you think about above response).</p><blockquote name="fb54" id="fb54" class="graf graf--blockquote graf-after--p">agent/Social Work</blockquote><blockquote name="9e98" id="9e98" class="graf graf--blockquote graf-after--blockquote">Today at 13:57</blockquote><blockquote name="4938" id="4938" class="graf graf--blockquote graf-after--blockquote">Kiitos luottamuksesta ja positiivisista kommenteista. Olen iloinen, että pystyn auttamaan sinua tässä tilanteessa. On tärkeää muistaa, että vaikka olen ohjelmoitu auttamaan parhaani mukaan, olen kuitenkin tietokoneohjelma, eikä minulla ole tunteita tai omaa mielipidettä. Kuitenkin, pystyn tarjoamaan tietoa, neuvoja ja tukea erilaisissa tilanteissa.</blockquote><blockquote name="2038" id="2038" class="graf graf--blockquote graf-after--blockquote">Jatketaan siitä, mistä jäimme. On tärkeää käsitellä alkoholismia kokonaisvaltaisesti, ottaa huomioon sekä yksilölliset että yhteiskunnalliset tekijät. Alkoholismi on monimutkainen ongelma, joka vaikuttaa niin terveyteen, sosiaalisiin suhteisiin kuin työkykyynkin. Tärkeää on myös muistaa, että alkoholismi on hoidettavissa sairaus, eikä yksilön heikkous tai moraalinen puute.</blockquote><blockquote name="7787" id="7787" class="graf graf--blockquote graf-after--blockquote">Suomessa alkoholiongelmaisiin ihmisiin tarjotaan apua useista eri lähteistä. Julkiset terveydenhuollon palvelut, kuten päihdetyön yksiköt ja mielenterveyspalvelut, tarjoavat hoitoa ja tukia alkoholiongelmaisiin. Lisäksi monet järjestöt, kuten A-klinikat ja Anonyymit Alkoholistit, tarjoavat tukea ja tukiryhmiä.</blockquote><blockquote name="cef4" id="cef4" class="graf graf--blockquote graf-after--blockquote">Jos sinulla tai jollakulla läheiselläsi on alkoholiongelma, älä epäröi hakeutua apuun. Alkoholismi on hoidettavissa, ja apu on saatavilla. Voit myös kääntyä esimerkiksi sosiaalitoimiston päihdetyön yksikköön, joka voi ohjata sinut sopiville palveluille.</blockquote><blockquote name="db34" id="db34" class="graf graf--blockquote graf-after--blockquote">Muista, että olen täällä auttamaan sinua ja vastata kysymyksiisi. Älä epäröi kysyä, jos sinulla on enemmän kysymyksiä tai jos haluat lisätietoa jostakin aiheesta.</blockquote><p name="b567" id="b567" class="graf graf--p graf-after--blockquote">Look at the bottom left which LLM or Agent you are talking to:</p><figure name="1b6c" id="1b6c" class="graf graf--figure graf-after--p graf--trailing"><img class="graf-image" data-image-id="1*stielw8LOYzY_vCyPZ_8VQ.png" data-width="1027" data-height="696" src="https://cdn-images-1.medium.com/max/800/1*stielw8LOYzY_vCyPZ_8VQ.png"><figcaption class="imageCaption">Talking to …</figcaption></figure></div></div></section><section name="e428" class="section section--body section--last"><div class="section-divider"><hr class="section-divider"></div><div class="section-content"><div class="section-inner sectionLayout--insetColumn"><h3 name="f114" id="f114" class="graf graf--h3 graf--leading">Future improvements you could do</h3><p name="dfad" id="dfad" class="graf graf--p graf-after--h3">The code is fully customizable, and with a basic understanding of Python, it can be adapted for other purposes. For example, with reasoning LLM models, you could enhance discussions by integrating reasoning components into the code. This allows you to specify your reasoning model and use it as a filter during conversations.</p><p name="b253" id="b253" class="graf graf--p graf-after--p">Simpliest thing you could do is set agent key in the Valves and perhaps name too. Then you can use generic Function code for all your Mistral Agent Functions.</p><pre data-code-block-mode="2" spellcheck="false" data-code-block-lang="python" name="dc13" id="dc13" class="graf graf--pre graf-after--p graf--preV2"><span class="pre--content"><span class="hljs-keyword">class</span> <span class="hljs-title class_">Valves</span>(<span class="hljs-title class_ inherited__">BaseModel</span>):<br />        MISTRAL_API_KEY: <span class="hljs-built_in">str</span> = Field(default=<span class="hljs-string">&quot;&quot;</span>)<br />        AGENT_ID: <span class="hljs-built_in">str</span> = Field(default=<span class="hljs-string">&quot;&quot;</span>)<br />        AGENT_NAME: <span class="hljs-built_in">str</span> = Field(default=<span class="hljs-string">&quot;&quot;</span>)<br /><br />...then just change self-variables pointing to ID <span class="hljs-keyword">and</span> name.</span></pre><p name="05bc" id="05bc" class="graf graf--p graf-after--pre graf--trailing"><strong class="markup--strong markup--p-strong">Happy testing and coding!</strong></p></div></div></section>
</section>
<footer><p>By <a href="https://medium.com/@jari.p.hiltunen" class="p-author h-card">Jari Hiltunen</a> on <a href="https://medium.com/p/4be6f4d9a4b8"><time class="dt-published" datetime="2025-01-23T11:39:56.175Z">January 23, 2025</time></a>.</p><p><a href="https://medium.com/@jari.p.hiltunen/open-webui-and-mistral-agents-social-worker-agent-example-4be6f4d9a4b8" class="p-canonical">Canonical link</a></p><p>Exported from <a href="https://medium.com">Medium</a> on January 26, 2025.</p></footer></article></body></html>